#define initshell_file#include <shell.h>#define p_dsize 0,0#define p_csize 1,0#define p_radius 2,0#define p_ONtime 0,1#define p_OFFtime 1,1#define p_frametime 2,1#define p_ndots 0,2#define p_debug 1,2#define b_runblocks 1#define b_runpractice 2#define ESC	0x1Bstatic int radius, csize, dsize, ndots;static int ONtime, OFFtime, T1start;static int trials, blocks, debug;static char *debuglist[] = {"OFF", "ON"};Rect dotrect[24], cuerect, fixrect;/********************************************************************************/// Draws a message in the center of the buffer/screen// message is a pascal string, usage: draw_message("\pthis is a message",0,0)static int draw_message(Str255 message, int buffer, int color){	startdrawscreen(buffer);	drawcolor(color);	MoveTo((screenrect.right-StringWidth(message))/2,screenrect.bottom/2);	DrawString(message);	enddrawscreen();        return true;	} /********************************************************************************/static int do_clock(int x, int y, float v){		int i;	float dotx, doty, angle;		if(isparam(p_dsize)) dsize=v;	else if(isparam(p_csize)) csize=v;	else if(isparam(p_radius)) radius=v;	else if(isparam(p_ndots)) ndots=v;		startdrawscreen(0);	EraseRect(&screenrect);    PenSize(2/*width*/, 2/*height*/);    drawcolor(0);        cuerect.top=(screenrect.bottom-screenrect.top)/2-csize/2;    cuerect.right=(screenrect.right-screenrect.left)/2+csize/2;    cuerect.bottom=cuerect.top+csize;    cuerect.left=cuerect.right-csize;    FrameOval(&cuerect/*arect*/);        fixrect.top=(screenrect.bottom-screenrect.top)/2-5;    fixrect.right=(screenrect.right-screenrect.left)/2+5;    fixrect.bottom=fixrect.top+10;    fixrect.left=fixrect.right-10;    PaintOval(&fixrect/*arect*/);            for(i=0;i<ndots;i++)     {           angle=360./ndots*i;            dotx=radius*cos((double)(90.-angle)*PI/180.);      doty=radius*sin((double)(90.-angle)*PI/180.);            //printf("%f, %f\n",dotx,doty);            dotrect[i].top=(screenrect.bottom-screenrect.top)/2-(int)doty-dsize/2;      dotrect[i].right=(screenrect.right-screenrect.left)/2+(int)dotx+dsize/2;      dotrect[i].bottom=dotrect[i].top+dsize;      dotrect[i].left=dotrect[i].right-dsize;            FrameOval(&dotrect[i]/*arect*/);     }         enddrawscreen();    		return false;}/********************************************************************************/static int do_stream(int buttonnum){	int i, j, k, ABtable[24];	int T1, T1reportP, T1reportT, key, mousekey;	long count1, count2;	float dotx, doty, angle;		EventRecord mymouse;		macwait(1);	usemainscreen(2000, false, set8bits+usecolours+keepgamma);		cuerect.top=(screenrect.bottom-screenrect.top)/2-csize/2;    cuerect.right=(screenrect.right-screenrect.left)/2+csize/2;    cuerect.bottom=cuerect.top+csize;    cuerect.left=cuerect.right-csize;        fixrect.top=(screenrect.bottom-screenrect.top)/2-5;    fixrect.right=(screenrect.right-screenrect.left)/2+5;    fixrect.bottom=fixrect.top+10;    fixrect.left=fixrect.right-10;            for(i=0;i<ndots;i++)     {           angle=360./ndots*i;            dotx=radius*cos((double)(90.-angle)*PI/180.);      doty=radius*sin((double)(90.-angle)*PI/180.);            dotrect[i].top=(screenrect.bottom-screenrect.top)/2-(int)doty-dsize/2;      dotrect[i].right=(screenrect.right-screenrect.left)/2+(int)dotx+dsize/2;      dotrect[i].bottom=dotrect[i].top+dsize;      dotrect[i].left=dotrect[i].right-dsize;           }     		setrandomseed(TickCount() /*user_seed*/);		startdrawscreen(0);		reservekeyboard(true);	mousekey=FALSE;	PaintOval(&fixrect/*arect*/);    macwait(1500*1E3/frametime);        T1start=ndots/2;    T1=T1start-1;    	    for(k=0;k<trials;k++)     {    	randomsequence(ndots /*length*/, ABtable /*shuffled list of dot positions*/);    	    	if(debug)    	 {    	   printf("%d\t%d\n",ABtable[T1]+1,T1+1);    	   continue;    	 }          	    	macwait(1);    	count1=iframecount;    	     	for(i=0;i<ndots;i++)     	{       		j=ABtable[i];       		       		PaintOval(&dotrect[j]);       		       		if(i==T1) FrameOval(&cuerect);       		       		count2=iframecount;       		if(count2>count1) {printf("Drawing takes more than a frame!\n"); break;}       		while((iframecount-count2)<ONtime) {}       		EraseOval(&dotrect[j]);       		if(i==T1) {EraseOval(&cuerect); PaintOval(&fixrect);}       		         		while((iframecount-count2)<(ONtime+OFFtime)) {}       		       		count1=iframecount;       		if(count2<(count1-ONtime-OFFtime)) {printf("Drawing takes more than a frame!\n"); break;}       		       	}  	    	    if(count2>count1) break;	    		for(i=0;i<ndots;i++) FrameOval(&dotrect[i]);				while(mousekey==FALSE)		 {		  		  while(GetNextEvent(mDownMask,&mymouse)==FALSE)		   {		     if((key=getkey())==ESC) break;		   }		  if(key==ESC) break;		  		  lastclickmousepos.h=mymouse.where.h;	      lastclickmousepos.v=mymouse.where.v;	      	      for(i=0;i<ndots;i++)	       {	        mousekey=PtInRect(lastclickmousepos,&dotrect[i]);	        if(mousekey==TRUE)	         {	          if(buttonnum==b_runblocks)	           {	            T1reportP=i+1;	            for(j=0;j<ndots;j++) {if(ABtable[j]==i) T1reportT=j+1;}	            printf("%d\t%d\t%d\t%d",ABtable[T1]+1,T1reportP, T1+1, T1reportT);	            for(j=0;j<ndots;j++) printf("\t%d",ABtable[j]+1);    		    printf("\n");    		   } 	          break;	         } 	       }	     } 	            EraseRect(&screenrect);        PaintOval(&fixrect/*arect*/);        mousekey=FALSE;        if(key==ESC) break;                macwait(1500*1E3/frametime);	 }			enddrawscreen();	reservekeyboard(false);		macwait(1);	usemainscreen(2000, true, set8bits+usecolours+keepgamma);		if(key==ESC) return(true);		return false;}/********************************************************************************/static int do_runpractice(int buttonnum){	int key;		putdialog("Press a key to start...\n",0);	while((key=getkey())=='\0'){}    removedialog();		trials=10;	do_stream(buttonnum);	do_clock(0,0,dsize);		return(false);	}	/********************************************************************************/static int do_runblocks(int buttonnum){	int i, key, result;	char myname[256], age[256], sex[256], hand[256], mymessage[256];		DateTimeRec datetime;	GetTime(&datetime);		askuser("Subject's name"/*prompt*/, myname/*answer*/);	askuser("Subject's age"/*prompt*/, age/*answer*/);	askuser("Subject's gender (M or F)"/*prompt*/, sex/*answer*/);	askuser("Subject's handedness (L or R)"/*prompt*/, hand/*answer*/);	printf("Experiment started on %02d/%02d/%02d at %02d:%02d:%02d with JumpDot\n",            datetime.month,datetime.day,datetime.year,            datetime.hour,datetime.minute,datetime.second);    printf("Subject: %s\nAge: %s\nGender: %s\nHandedness: %s\n",myname,age,sex,hand);    printf("Jumps: %d\n",ndots);    printf("Dot diameter: %d pixels\n", dsize);    printf("Target diameter: %d pixels\n", 2*radius);    printf("Cue diameter: %d pixels\n", csize);    printf("ON time: %.2f ms\nOFF time: %.2f ms\n",(float)ONtime*frametime/1E3,(float)OFFtime*frametime/1E3);            trials=100;	blocks=4;				for(i=0;i<blocks;i++)	 {		sprintf(mymessage,"%d blocks to do. \nPress a key to start...\n",blocks-i);		putdialog(mymessage,0);		while((key=getkey())=='\0'){}    	removedialog();    	if(key==ESC) break;    	    	if(debug)     	printf("T1-P\tT1-T\n");    	else    	printf("T1-P\tT1-repP\tT1-T\tT1-repT\tStream\n");		    if((result=do_stream(buttonnum))==true) break;	 }  	 	GetTime(&datetime);	printf("Experiment finished at %02d:%02d:%02d\n",            datetime.hour,datetime.minute,datetime.second); 	if(result==false) putdialog("You are done. Thank you!\n",0);	else putdialog("Aborted!\n",0);	macwait((int)(2000/(frametime/1E3)));	removedialog();	    	do_clock(0,0,dsize);		return(false);	}	/********************************************************************************/void initshell(void){	usemainscreen(1000, true, set8bits+usecolours+keepgamma);/* set button table */	addbutton(b_runblocks, "Run Blocks", do_runblocks);	addbutton(b_runpractice, "Practice", do_runpractice);/* set parameters table */	dsize = 20;	addintparameter(p_dsize , "Dot size", dsize, 0, 1000,						NULL, do_clock, NULL, do_clock);	setparameterunit(p_dsize /*x,y*/, "pix" /*unittext*/);		csize =360;	addintparameter(p_csize , "Cue size", csize, 0, 1000,						NULL, do_clock, NULL, do_clock);		radius=200;	addintparameter(p_radius , "Clock radius", radius, 0, 1000,						NULL, do_clock, NULL, do_clock);							ONtime=2;	addintparametervar(p_ONtime, "ON time", ONtime, 0, 1E6,						nil, nil, nil, &ONtime);	setparameterunit(p_ONtime, "frames");		OFFtime=4;	addintparametervar(p_OFFtime, "OFF time", OFFtime, 0, 1E6,						nil, nil, nil, &OFFtime);	setparameterunit(p_OFFtime, "frames");	addparametervar(p_frametime, "Frametime", 4, (float)frametime/1E3, 0, 1E6,						nil, nil, nil, nil);	setparameterunit(p_frametime, "ms");						enableparameter(p_frametime,false); 		ndots=24;	addintparameter(p_ndots , "# jumps", ndots, 1, 24,						NULL, do_clock, NULL, do_clock);							debug=0;	addlistparametervar(p_debug,"Debug state",debug,2,debuglist,	                    NULL,&debug,NULL,&debug);							startdrawscreen(0);    erasecolor(255);    EraseRect(&screenrect);    enddrawscreen();        do_clock(p_dsize,dsize);	}void mainloop(void){}